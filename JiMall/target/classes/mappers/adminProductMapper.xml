<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.jimall.mappers.AdminProductMapper">
	
	<!-- 1차 카테고리 출력 -->
	<select id="mainCateList" resultType="CategoryVO">
		select cate_thcode, cate_pracode, cate_name 
		from category_tbl
		where cate_pracode is null
	</select>

	<!-- 1차 카테고리에 따른 2차카테고리 출력 -->
	<select id="subCateList" parameterType="string" resultType="CategoryVO">
		select cate_thcode, cate_pracode, cate_name
		from category_tbl
		where cate_pracode = #{cate_thcode}	
	</select>
	
	<!-- 상품등록 -->
	<select id="insertProduct" parameterType="ProductVO">
		insert into productinfo_tbl(prod_num, cate_thcode, cate_pracode, prod_name, prod_price, prod_discount, prod_develop, prod_detailint, 
									prod_img, prod_cominven, prod_buypos, prod_regisdate)
		values(seq_prod_num.NEXTVAL, #{cate_thcode}, #{cate_pracode}, #{prod_name}, #{prod_price}, #{prod_discount}, #{prod_develop}, #{prod_detailint},
		 							#{prod_img}, #{prod_cominven}, #{prod_buypos}, sysdate)	
	</select>
	
	
	<!-- 검색 조건 : 공통 사용 구문 -->
	<sql id="search">
		<if test="searchType != null">
			<!-- 상품명 -->
			<if test="searchType == 'name'.toString()">
				where prod_name like '%' || #{keyword} || '%'
			</if>
			<!-- 내용 -->
			<if test="searchType == 'detailint'.toString()">
				where prod_detailint like '%' || #{keyword} || '%'
			</if>
			<!-- 제조사 -->
			<if test="searchType == 'develop'.toString()">
				where prod_develop like '%' || #{keyword} || '%'
			</if>
			<!-- 상품명 + 내용 -->
			<if test="searchType == 'name_detailint'.toString()">
				where (prod_name like '%' || #{keyword} || '%') or
				      (prod_detailint like '%' || #{keyword} || '%')
			</if>
			<!-- 상품명 + 제조사 -->
			<if test="searchType == 'name_develop'.toString()">
				where (prod_name like '%' || #{keyword} || '%') or
					  (prod_develop like '%' || #{keyword} || '%')
			</if>
			<!-- 상품명 + 내용 + 제조사 -->
			<if test="searchType == 'all'.toString()">
				where (prod_name like '%' || #{keyword} || '%') or
				 	  (prod_detailint like '%' || #{keyword} || '%') or
				 	  (prod_develop like '%' || #{keyword} || '%')
			</if>
		</if>
	</sql>
	
	<!-- 상품 리스트 -->
	<!-- 인라인 뷰가 사용 됨
	     from 절에 있는 row_number은 순번을 정해주는 구문
	     q_seq는 그 순번을 정해준 row_number의 이름
	         인라인 뷰로 괄호 안에 from절이 먼저 실행 후에 
	         조건 식이 실행이 됨 
	         그냥 from product_tbl과 p_seq가 동일 선상에서 사용할 수 없기 때문에 
	         사용하는 구문임  -->
	        
	<select id="searchList"  resultType="ProductVO">
		select prod_num, cate_thcode, prod_name, prod_price, prod_discount, prod_develop, prod_detailint,
		       prod_img, prod_cominven, prod_buypos, prod_regisDate, prod_updateDate
		from (select prod_num, cate_thcode, prod_name, prod_price, prod_discount, prod_develop, prod_detailint,
		      prod_img, prod_cominven, prod_buypos, prod_regisDate, prod_updateDate,
		      row_number() over (order by prod_num desc) p_seq from productinfo_tbl
		      <include refid="search" /> )
		where p_seq between #{rowStart} and #{rowEnd}            
	</select>
	
	<select id="searchListCount" resultType="int">
		<![CDATA[
			select count(prod_num)
			from productinfo_tbl
		]]>
		<include refid="search" />
	</select>
	
	<!-- 상품 정보 읽기 -->
	<select id="readProduct" resultType="ProductVO">
		select p.prod_num, p.cate_thcode, c.cate_pracode, p.prod_name, p.prod_price, p.prod_discount,
		       p.prod_develop, p.prod_detailint, p.prod_img, p.prod_cominven, p.prod_buypos, p.prod_regisDate, p.prod_updateDate
		from productinfo_tbl p inner join category_tbl c
		on p.cate_thcode = c.cate_thcode
		where p.prod_num = #{prod_num}
	</select>
	
	<!-- 상품 수정 -->
	<select id="editProduct" resultType="ProductVO">
		update productinfo_tbl
		set cate_thcode=#{cate_thcode}, prod_name=#{prod_name}, prod_price=#{prod_price}, prod_discount=#{prod_discount},
			prod_develop=#{prod_develop}, prod_detailint=#{prod_detailint}, prod_img=#{prod_img}, prod_cominven=#{prod_cominven},
			prod_buypos=#{prod_buypos}, prod_updatedate=sysdate
		where prod_num=#{prod_num}	
	</select>
	
	<!-- 선택 상품 수정 -->
	<update id="editChecked">
		update prodinfo_tbl
		set	prod_cominven=#{prod_cominven}, prod_buypos=#{prod_buypos}, prod_updatedate=sysdate
		where prod_num=#{prod_num}
	</update>
	
	<!-- 상품 삭제 -->
	<delete id="deleteProduct">
		delete productinfo_tbl
		where prod_num = #{prod_num}
	</delete>
	
</mapper>